# =============================================================================
# Docker Compose para Producción - Compatible con Dokploy
# =============================================================================
#
# Servicios incluidos:
# - web: Django + Gunicorn
# - redis: Cache (opcional pero recomendado)
#
# Variables de entorno requeridas en Dokploy:
#   SECRET_KEY, ALLOWED_HOST, CSRF_TRUSTED_ORIGIN
#
# Variables opcionales:
#   DB_ENGINE, DB_NAME, DB_USER, DB_PASS, DB_HOST, DB_PORT
#   HCAPTCHA_SITEKEY, HCAPTCHA_SECRET
#   EMAIL_HOST, EMAIL_PORT, EMAIL_HOST_USER, EMAIL_HOST_PASSWORD
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Django Application
  # ---------------------------------------------------------------------------
  web:
    build: .
    restart: always
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.prod
      - REDIS_URL=redis://redis:6379/0
      # Se configuran las demás variables en Dokploy UI
    volumes:
      # Volúmenes para persistencia de archivos estáticos/media solamente
      # NO montar sobre /app/plataforma/config (contiene el código de settings)
      - ../files/static:/app/plataforma/staticfiles
      - ../files/media:/app/plataforma/media
      - ../files/db:/app/plataforma/data
    ports:
      - "8000:8000"
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # Redis Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - ../files/redis:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
